# Create a self-signed CA key and cert.
gnutls-certtool \
  --generate-privkey \
  --outfile ca.key.pem

cat <<EOF >ca.info
cn = Göteborg Bit Factory
ca
cert_signing_key
EOF

gnutls-certtool \
  --generate-self-signed \
  --load-privkey ca.key.pem \
  --template ca.info \
  --outfile ca.cert.pem
rm ca.info

# Inspect with:
#   gnutls-certtool -i --infile ca.cert.pem


# Issue a server cert.
gnutls-certtool \
  --generate-privkey \
  --outfile server.key.pem

cat <<EOF >server.info
organization = Göteborg Bit Factory
cn = tasktools.org
tls_www_server
encryption_key
signing_key
EOF

gnutls-certtool \
  --generate-certificate \
  --load-privkey server.key.pem \
  --load-ca-certificate ca.cert.pem \
  --load-ca-privkey ca.key.pem \
  --template server.info \
  --outfile server.cert.pem
rm server.info


# Issue a client cert.
gnutls-certtool \
  --generate-privkey \
  --outfile client.key.pem

cat <<EOF >client.info
country = SE
state = Västra Götaland
locality = Göteborg
organization = Göteborg Bit Factory
cn = Taskwarrior
tls_www_client
encryption_key
signing_key
EOF

gnutls-certtool \
  --generate-certificate \
  --load-privkey client.key.pem \
  --load-ca-certificate ca.cert.pem \
  --load-ca-privkey ca.key.pem \
  --template client.info \
  --outfile client.cert.pem
rm client.info

# CRL - Certificate Revocation List

# Empty CRL
cat <<EOF >crl.info
expiration_days = 365
EOF

gnutls-certtool \
  --generate-crl \
  --load-ca-privkey ca.key.pem \
  --load-ca-certificate ca.cert.pem \
  --template crl.info \
  --outfile server.crl.pem
rm crl.info

# To create a CRL that contains some revoked certificates, place the
# certificates in a file and use --load-certificate as follows:
# gnutls-certtool \
#   --generate-crl \
#   --load-ca-privkey ca.key.pem \
#   --load-ca-certificate ca.cert..pem \
#   --load-certificate revoked-certs.pem

# To verify a CRL:
#   gnutls-certtool --verify-crl --load-ca-certificate ca.cert.pem --infile server.crl.pem

chmod 600 *pem

